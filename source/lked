#!/bin/bash

if [ $# -lt 1 ] ; then
 echo "Usage: $0 [executable]"
 echo "Generated executable will be [executable].exe in ../bin"
 exit 0
fi

EXEDIR=../bin
EXE=$1

if [ -e $EXEDIR/$EXE.exe ] ; then
  echo "Executable $EXE.exe exists in ../bin. Exiting..."
  exit 0
fi

# OpenMP compilation
#F77=ftn
#OPT='-openmp -parallel -fpp -traceback -check all -integer-size 64'                            # Chet's options
#OPT='-O2 -openmp -integer-size 64 -fp-model strict -no-ftz'                                    # UIUC cluster options
#OPT='-O2 -openmp -openmp-link static -integer-size 64 -fp-model strict -no-ftz -xHOST -ipo'    # LionXF/PSU cluster options
#OPT='-O2 -openmp -traceback -check all -integer-size 64 -fp-model strict -no-ftz -ipo'         # Debug options
#OPT='-O2 -fast -mp=nonuma -i8 -r8 -Mnoflushz -Ktrap=fp'

# Hybrid MPI/OpenMP compilation
F77=ftn
#OPT='-O2 -openmp -integer-size 64 -fp-model strict -no-ftz -DMPI32 -ipo'               # Intel
#OPT='-O2 -mp=nonuma -i8 -i8storage -r8 -Mnoflushz -Ktrap=fp -Mcache_align -default64'  # PGI64
#OPT='-O2 -mp=nonuma -i8 -i8storage -r8 -Mnoflushz -Ktrap=fp -Mcache_align -DMPI32'     # PGI32
OPT='-O2 -s default64 -Ktrap=fp'                                                       # Cray

# Kurt's specifications
#F77=mpif77
#OPT='-lgomp -fopenmp -O2 -L/usr/local/lib -llapack -lblas  -I/usr/local/include -I/usr/local/lib/gcc/x86_64-apple-darwin12.2.0/4.8.0/finclude'

# UIUC cluster Intel/MKL
#LIBDIR=/opt/intel/Compiler/11.1/075/mkl/lib/em64t
#LIB="-L$LIBDIR -Wl,--start-group $LIBDIR/libmkl_intel_lp64.a $LIBDIR/libmkl_intel_thread.a $LIBDIR/libmkl_core.a -Wl,--end-group -liomp5 -lpthread -lm"

# Libraries
#LIB='-L/opt/acml/5.3.0/open64_64_int64/lib -lm -lacml'          # UIUC cluster Open64/ACML
LIB='-L$CRAY_LIBSCI_PREFIX_DIR/lib -lsci_cray'                  # Blue Waters serial Cray libsci
#LIB='/opt/cray/libsci/13.0.1/CRAY/83/x86_64/lib/libsci_cray.a'  # Blue Waters serial Cray libsci (specific)
#LIB='-L/opt/acml/5.3.1/pgi64_int64/lib -lacml'                  # Blue Waters PGI/ACML

# Andrew's specifications:
#F77=mpif90
#OPT='-O2 -fopenmp -fdefault-integer-8 -fdefault-real-8 -fdefault-double-8 -DMPI32'
#LIB='-L/etc/lapack-3.5.0 -llapack -lblas'

FILS='../object/*.o'

set echo

echo Using compiler $F77 with options $OPT to link files
echo
echo $FILS
echo
echo with libraries
echo
echo $LIB
echo
echo to executable $EXE.exe in ../bin

$F77 $OPT -o $EXEDIR/$EXE.exe $FILS $LIB

echo Done.

unset echo

